<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3-Minute Conflict Pair Diagnostic | Logos & Praxis</title>
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QEWYMTSMJQ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-QEWYMTSMJQ');
  </script>
  
  <meta name="theme-color" content="#0B0B0C">
  <meta name="description" content="Discover your constraint pattern in 3 minutes. Take the free conflict pair diagnostic.">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* ... (your existing CSS remains exactly the same) ... */
  </style>
</head>
<body>
  <div class="container">
    <img src="/assets/logospraxis-glyph.png" alt="Logos & Praxis" class="logo-glyph">

    <!-- HEADER -->
    <div class="header">
      <h1>3-Minute Conflict Pair Diagnostic</h1>
      <p>Discover your constraint pattern. Free. Instant results.</p>
    </div>

    <!-- PROGRESS BAR -->
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">Question 1 of 3</div>
    </div>

    <!-- QUESTION 1: Physical Alarm -->
    <div class="question-section active" id="question1">
      <h2 class="question-title">What physical signal do you notice when work feels "off"?</h2>
      <p class="question-subtitle">This is your alarm. Your body knows before your mind does.</p>
      
      <div class="options-container">
        <div class="option-card" data-q="q1" data-value="jaw">
          Jaw clenches
        </div>
        <div class="option-card" data-q="q1" data-value="breathing">
          Breathing shallows
        </div>
        <div class="option-card" data-q="q1" data-value="chest">
          Chest tightens
        </div>
        <div class="option-card" data-q="q1" data-value="time">
          Time distorts
        </div>
      </div>
    </div>

    <!-- QUESTION 2: Triggering Activity -->
    <div class="question-section" id="question2">
      <h2 class="question-title">What were you doing right before that signal fired?</h2>
      <p class="question-subtitle">The activity that triggers the alarm reveals what you're optimizing for.</p>
      
      <div class="options-container">
        <div class="option-card" data-q="q2" data-value="messages">
          Responding to messages/Slack
        </div>
        <div class="option-card" data-q="q2" data-value="meetings">
          In a meeting or on a call
        </div>
        <div class="option-card" data-q="q2" data-value="reviewing">
          Reviewing or approving work
        </div>
        <div class="option-card" data-q="q2" data-value="planning">
          Planning or strategizing
        </div>
        <div class="option-card" data-q="q2" data-value="switching">
          Context-switching between tasks
        </div>
      </div>
    </div>

    <!-- QUESTION 3: Deferred Work -->
    <div class="question-section" id="question3">
      <h2 class="question-title">What work did you defer to do that?</h2>
      <p class="question-subtitle">The work you postpone reveals what your system neglects.</p>
      
      <div class="options-container">
        <div class="option-card" data-q="q3" data-value="deep_work">
          Deep work / focused execution
        </div>
        <div class="option-card" data-q="q3" data-value="decisions">
          Decision-making / killing options
        </div>
        <div class="option-card" data-q="q3" data-value="strategy">
          Strategy / big-picture thinking
        </div>
        <div class="option-card" data-q="q3" data-value="learning">
          Learning / skill-building
        </div>
        <div class="option-card" data-q="q3" data-value="shipping">
          Shipping / finishing things
        </div>
      </div>
    </div>

    <!-- RESULT SECTION -->
    <div class="result-section" id="resultSection">
      <div class="result-header">
        <h2 class="result-title" id="resultPairTitle">VISIBILITY vs OWNERSHIP</h2>
        <p class="result-subtitle">Your Conflict Pair</p>
      </div>

      <div class="result-block">
        <div class="result-label">Your Alarm Pattern</div>
        <div class="result-content" id="resultPattern"></div>
      </div>

      <div class="result-block">
        <div class="result-label">Why Your System Does This</div>
        <div class="result-content" id="resultMechanism"></div>
      </div>

      <div class="result-block">
        <div class="result-label">The Reinforcement Loop</div>
        <div class="result-content" id="resultLoop"></div>
      </div>

      <div class="result-block">
        <div class="result-label">What You're Losing</div>
        <div class="result-content" id="resultCost"></div>
      </div>

      <div class="result-highlight">
        <p id="resultHighlight"><strong>Your system is designed to favor visibility over ownership.</strong> That's why the alarm keeps firing. No amount of discipline fixes architectural problems.</p>
      </div>

      <div class="result-block">
        <div class="result-label">The Fix: System Design</div>
        <div class="result-content" id="resultFix"></div>
      </div>

      <!-- EMAIL CAPTURE -->
      <div class="email-capture">
        <h3>Want the full breakdown?</h3>
        <p>Get your conflict pair analysis + 8-week system overview via email.</p>
        <form class="email-form" id="emailForm">
          <input type="email" id="emailInput" placeholder="you@company.com" required>
          <button type="submit" id="submitButton">Send Results</button>
        </form>
        <div class="email-success" id="emailSuccess">✓ Check your email for the full analysis.</div>
        <div class="email-error" id="emailError" style="display: none; color: #ef4444; font-size: 14px; margin-top: var(--space-12);">✗ Failed to send. Please try again.</div>
      </div>

      <!-- CTAs -->
      <a href="/system-map" class="cta-pill">
        Get the 8-Week System →
      </a>
      
      <button class="cta-pill cta-secondary" id="restartBtn">
        Take Diagnostic Again
      </button>
    </div>
  </div>

  <script>
    // State
    const answers = {
      q1: null,
      q2: null,
      q3: null
    };

    let currentQuestion = 1;
    const totalQuestions = 3;

    // Conflict Pair Logic with Full Mechanism (your existing conflictPairs object remains exactly the same)
    const conflictPairs = {
      // ... (your existing conflictPairs object remains exactly the same) ...
    };

    // Elements
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');

    // Initialize the first question
    showQuestion(1);

    // Handle option selection using event delegation
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('option-card')) {
        const card = e.target;
        const question = card.dataset.q;
        const value = card.dataset.value;
        
        console.log('Card clicked:', question, value);
        
        // Store answer
        answers[question] = value;

        // Track in GA (with fallback)
        try {
          if (typeof gtag !== 'undefined') {
            gtag('event', 'diagnostic_answer', {
              'event_category': 'engagement',
              'event_label': `${question}_${value}`,
              'value': currentQuestion
            });
          }
        } catch (e) {
          console.log('GA tracking failed:', e);
        }

        // Visual feedback
        document.querySelectorAll(`[data-q="${question}"]`).forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');

        // Wait briefly then advance
        setTimeout(() => {
          advanceQuestion();
        }, 300);
      }
    });

    function showQuestion(questionNum) {
      // Hide all questions
      document.querySelectorAll('.question-section').forEach(q => {
        q.classList.remove('active');
      });
      
      // Show the specified question
      document.getElementById(`question${questionNum}`).classList.add('active');
      
      // Update progress
      const progress = ((questionNum - 1) / totalQuestions) * 100;
      progressFill.style.width = `${progress}%`;
      progressText.textContent = `Question ${questionNum} of ${totalQuestions}`;
    }

    function advanceQuestion() {
      // Check if we have an answer for the current question
      if (!answers[`q${currentQuestion}`]) {
        console.log('No answer selected for current question');
        return;
      }

      // Move to next question or show results
      if (currentQuestion < totalQuestions) {
        currentQuestion++;
        showQuestion(currentQuestion);
      } else {
        // All questions answered, show results
        progressText.textContent = 'Complete';
        progressFill.style.width = '100%';
        showResult();
      }
    }

    function showResult() {
      const key = `${answers.q2}-${answers.q3}`;
      const result = conflictPairs[key] || conflictPairs['fallback'];

      console.log('Showing result for:', key, result.pair);

      // Populate result
      document.getElementById('resultPairTitle').textContent = result.pair;
      document.getElementById('resultPattern').innerHTML = result.pattern;
      document.getElementById('resultMechanism').innerHTML = result.mechanism;
      document.getElementById('resultLoop').innerHTML = result.loop;
      document.getElementById('resultCost').innerHTML = result.cost;
      document.getElementById('resultFix').innerHTML = result.fix;
      document.getElementById('resultHighlight').innerHTML = `<strong>Your system is designed to favor ${result.favor}.</strong> That's why the alarm keeps firing. No amount of discipline fixes architectural problems.`;

      // Track in GA (with fallback)
      try {
        if (typeof gtag !== 'undefined') {
          gtag('event', 'diagnostic_complete', {
            'event_category': 'conversion',
            'event_label': result.pair,
            'value': 1
          });
        }
      } catch (e) {
        console.log('GA tracking failed:', e);
      }

      // Hide all questions and show result section
      document.querySelectorAll('.question-section').forEach(q => {
        q.classList.remove('active');
      });
      document.getElementById('resultSection').classList.add('active');
      
      // Scroll to result section
      document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Email capture with better error handling
    document.getElementById('emailForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('emailInput').value;
      const key = `${answers.q2}-${answers.q3}`;
      const result = conflictPairs[key] || conflictPairs['fallback'];
      const submitButton = document.getElementById('submitButton');
      const originalButtonText = submitButton.textContent;

      // Show loading state
      submitButton.textContent = 'Sending...';
      submitButton.disabled = true;
      document.getElementById('emailError').style.display = 'none';

      try {
        // Send to backend
        const response = await fetch('/api/submit-diagnostic', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            email,
            answers,
            conflictPair: result.pair,
            timestamp: new Date().toISOString()
          })
        });

        const data = await response.json();

        if (response.ok && data.ok) {
          // Track in GA (with fallback)
          try {
            if (typeof gtag !== 'undefined') {
              gtag('event', 'diagnostic_email_capture', {
                'event_category': 'conversion',
                'event_label': result.pair,
                'value': 1
              });
            }
          } catch (e) {
            console.log('GA tracking failed:', e);
          }

          // Show success
          document.getElementById('emailSuccess').classList.add('show');
          document.getElementById('emailForm').style.display = 'none';
        } else {
          throw new Error(data.error || 'Failed to send email');
        }
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('emailError').style.display = 'block';
        document.getElementById('emailError').textContent = `✗ ${error.message}`;
        
        // Reset button
        submitButton.textContent = originalButtonText;
        submitButton.disabled = false;
      }
    });

    // Restart
    document.getElementById('restartBtn').addEventListener('click', () => {
      // Reset state
      answers.q1 = null;
      answers.q2 = null;
      answers.q3 = null;
      currentQuestion = 1;

      // Reset UI
      document.querySelectorAll('.option-card').forEach(card => card.classList.remove('selected'));
      document.getElementById('resultSection').classList.remove('active');
      document.getElementById('emailSuccess').classList.remove('show');
      document.getElementById('emailForm').style.display = 'flex';
      document.getElementById('emailError').style.display = 'none';
      document.getElementById('emailInput').value = '';
      
      // Show first question
      showQuestion(1);

      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });

      // Track in GA (with fallback)
      try {
        if (typeof gtag !== 'undefined') {
          gtag('event', 'diagnostic_restart', {
            'event_category': 'engagement',
            'value': 1
          });
        }
      } catch (e) {
        console.log('GA tracking failed:', e);
      }
    });
  </script>
</body>
</html>
